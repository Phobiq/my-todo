<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mijn Kanban Todo Lijst</title>
  <style>
    /* Loading overlay */
#loading {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.6);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s;
}
#loading.show {
  opacity: 1;
  pointer-events: all;
}
.spinner {
  width: 60px;
  height: 60px;
  border: 6px solid #f3f3f3;
  border-top: 6px solid #5aac44;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
#loading-text {
  color: white;
  margin-top: 20px;
  font-size: 18px;
}
    body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
    h1 { text-align: center; }
    .board { display: flex; gap: 20px; justify-content: center; flex-wrap: wrap; }
    .column {
      background: #e2e4e6; border-radius: 8px; padding: 10px; width: 300px; min-height: 500px;
    }
    .column h2 { text-align: center; margin: 0 0 10px 0; }
    .add-card { margin-bottom: 10px; }
    .add-card input { width: 100%; padding: 8px; box-sizing: border-box; }
    .add-card button { width: 100%; padding: 8px; margin-top: 5px; background: #5aac44; color: white; border: none; cursor: pointer; }
    .card {
      background: white; padding: 12px; margin-bottom: 8px; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.2);
      cursor: grab;
      position: relative;
    }
    .card:hover { box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
    .card.dragging { opacity: 0.5; }
    .delete-btn {
      position: absolute; top: 4px; right: 4px; background: #c33; color: white;
      border: none; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; cursor: pointer;
    }
    .edit-btn {
      position: absolute; top: 4px; right: 28px; background: #666; color: white;
      border: none; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; cursor: pointer;
    }
    .card.selected {
  outline: 4px solid #5aac44;
  box-shadow: 0 0 12px rgba(90, 172, 68, 0.6);
  z-index: 100;
}
  </style>
</head>
<body>
  <div id="loading">
  <div>
    <div class="spinner"></div>
    <div id="loading-text">Taken laden…</div>
  </div>
</div>
  <h1>Mijn Kanban Todo Lijst</h1>
  <div class="board">
    <div class="column" id="todo">
      <h2>To Do</h2>
      <div class="add-card">
        <input type="text" placeholder="Nieuwe taak..." id="input-todo" />
        <button onclick="addCard('todo')">Toevoegen</button>
      </div>
      <div class="cards" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
    </div>

    <div class="column" id="doing">
      <h2>Doing</h2>
      <div class="add-card">
        <input type="text" placeholder="Nieuwe taak..." id="input-doing" />
        <button onclick="addCard('doing')">Toevoegen</button>
      </div>
      <div class="cards" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
    </div>

    <div class="column" id="done">
      <h2>Done</h2>
      <div class="add-card">
        <input type="text" placeholder="Nieuwe taak..." id="input-done" />
        <button onclick="addCard('done')">Toevoegen</button>
      </div>
      <div class="cards" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
    </div>
  </div>

  <!-- VERVANG DEZE URL DOOR JOUW EIGEN WEB APP URL -->
<!-- ... (je HTML blijft hetzelfde tot aan <script>) ... -->

<script>
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzg8bYvvftzNeB9w2m3hhVIGvzU1-kGITQhbbf5S7ONWutcSYL7BdHzDX4G_SgH55eodA/exec";  // ← NIEUWE URL!

  // Globale callback-functies voor JSONP
  window.handleGetAll = function(data) {
    document.querySelectorAll(".cards").forEach(c => c.innerHTML = "");
    data.forEach(task => {
      createCardElement(task.id, task.title, task.status);
    });
  };

  window.handleAdd = function(data) {
    if (data.error) return alert(data.error);
    createCardElement(data.id, data.title, data.status);
  };

window.handleUpdate = function(data) {
  // Wordt nu alleen gebruikt bij titel bewerken
  if (data && data.error) {
    alert("Opslaan mislukt: " + data.error);
  }
  hideLoading();
  // Geen loadTasks() meer → voorkomt flikkering
};

  window.handleDelete = function(data) {
    if (!data.success) console.error("Delete mislukt");
    loadTasks();  // Refresh na delete
  };

  window.handleStatusUpdate = function(data) {
  // We doen hier niks met de response, want we hebben al optimistisch verplaatst
  // Alleen foutafhandeling als je wil:
  if (data && data.error) {
    alert("Verplaatsen mislukt: " + data.error);
    loadTasks(); // fallback: hele lijst opnieuw laden
  }
};

function showLoading(text = "Taken laden…") {
  document.getElementById("loading-text").textContent = text;
  document.getElementById("loading").classList.add("show");
}

function hideLoading() {
  document.getElementById("loading").classList.remove("show");
}
  
function loadTasks() {
  showLoading("Taken laden…");
  const script = document.createElement('script');
  script.src = `${SCRIPT_URL}?action=getAll&callback=handleGetAll`;
  script.onerror = () => {
    hideLoading();
    alert("Kan geen verbinding maken met Google Sheets");
  };
  document.head.appendChild(script);
  script.onload = () => {
    document.head.removeChild(script);
    setTimeout(hideLoading, 300); // kleine fade-out
  };
}

  function createCardElement(id, title, status) {
    const column = document.querySelector(`#${status} .cards`);
    const div = document.createElement("div");
    div.className = "card";
    div.draggable = true;
    div.dataset.id = id;
    div.dataset.status = status;
    div.ondragstart = drag;

    div.innerHTML = `
      <div>${title.replace(/\n/g, "<br>")}</div>
      <button class="edit-btn" onclick="editCard(this, '${id}')">✎</button>
      <button class="delete-btn" onclick="deleteCard('${id}', this)">×</button>
    `;

    column.appendChild(div);
  }

function addCard(columnId) {
  const input = document.getElementById(`input-${columnId}`);
  const title = input.value.trim();
  if (!title) return;
  input.value = "";
  showLoading("Toevoegen…");

  const script = document.createElement('script');
  script.src = `${SCRIPT_URL}?action=add&title=${encodeURIComponent(title)}&callback=handleAdd`;
  document.head.appendChild(script);
  script.onload = () => {
    document.head.removeChild(script);
    hideLoading();
  };
}

function updateCard(id, newTitle, newStatus) {
  showLoading("Opslaan…");
  const params = new URLSearchParams();
  params.append("action", "update");
  params.append("id", id);
  if (newTitle !== undefined) params.append("title", newTitle);
  if (newStatus !== undefined) params.append("status", newStatus);

  const script = document.createElement('script');
  script.src = `${SCRIPT_URL}?${params}&callback=handleUpdate`;
  document.head.appendChild(script);
  script.onload = () => {
    document.head.removeChild(script);
    hideLoading();
  };
}

function deleteCard(id, btn) {
  if (!confirm("Weet je zeker dat je deze taak wilt verwijderen?")) return;
  showLoading("Verwijderen…");

  const script = document.createElement('script');
  script.src = `${SCRIPT_URL}?action=delete&id=${id}&callback=handleDelete`;
  document.head.appendChild(script);
  script.onload = () => {
    document.head.removeChild(script);
    hideLoading();
    btn.parentElement.remove();
  };
}

  function editCard(btn, id) {
    const card = btn.parentElement;
    const currentText = card.firstChild.textContent;
    const textarea = document.createElement("textarea");
    textarea.value = currentText;
    textarea.style.width = "100%";
    card.firstChild.replaceWith(textarea);
    textarea.focus();

    const save = () => {
      const newText = textarea.value.trim() || "Lege taak";
      card.innerHTML = `<div>${newText.replace(/\n/g, "<br>")}</div>
        <button class="edit-btn" onclick="editCard(this, '${id}')">✎</button>
        <button class="delete-btn" onclick="deleteCard('${id}', this)">×</button>`;
      updateCard(id, newText);
    };

    textarea.addEventListener("blur", save);
    textarea.addEventListener("keydown", e => { 
      if (e.key === "Enter" && !e.shiftKey) { 
        e.preventDefault(); 
        save(); 
      } 
    });
  }

  // Drag & Drop (ongewijzigd)
function drop(e) {
  e.preventDefault();
  const id = e.dataTransfer.getData("text");
  const card = document.querySelector(`[data-id="${id}"]`);
  if (!card) return;
  card.classList.remove("dragging");

  const newColumn = e.target.closest(".column").id;

  // Alleen updaten als de kolom echt veranderd is
  if (card.dataset.status !== newColumn) {
    // Eerst visueel verplaatsen
    e.target.closest(".cards").appendChild(card);
    card.dataset.status = newColumn;

    // Optimistic update: meteen doorvoeren zonder te wachten op volledige refresh
    showLoading("Verplaatsen…");

    const params = new URLSearchParams();
    params.append("action", "update");
    params.append("id", id);
    params.append("status", newColumn);

    const script = document.createElement('script');
    script.src = `${SCRIPT_URL}?${params}&callback=handleStatusUpdate`;
    document.head.appendChild(script);
    script.onload = () => {
      document.head.removeChild(script);
      hideLoading();
      // Optioneel: alleen refreshen als je andere mensen tegelijk willen zien
      // loadTasks();   ← uitzetten = sneller en geen flikkering!
    };
  } else {
    // Gewoon binnen dezelfde kolom: toch netjes neerzetten
    e.target.closest(".cards").appendChild(card);
  }
}

  // Laad bij starten
function allowDrop(e) {
    e.preventDefault();
  }

  function drag(e) {
    e.dataTransfer.setData("text", e.target.dataset.id);
    e.target.classList.add("dragging");
  }

  // Laad bij starten
// ========= TOETSENBORD-NAVIGATIE =========
let selectedCard = null;

function selectCard(card) {
  // Verwijder oude selectie
  document.querySelectorAll(".card.selected").forEach(c => c.classList.remove("selected"));
  // Nieuwe selectie
  if (card) {
    card.classList.add("selected");
    selectedCard = card;
    card.scrollIntoView({ behavior: "smooth", block: "center" });
  } else {
    selectedCard = null;
  }
}

// Klik op een kaartje = selecteren
document.addEventListener("click", e => {
  const card = e.target.closest(".card");
  if (card) {
    selectCard(card);
  } else if (!e.target.closest(".column")) {
    selectCard(null); // klik buiten = deselecteren
  }
});

// Toetsenborduitleg
document.addEventListener("keydown", e => {
  if (!selectedCard) return;

  const currentCol = selectedCard.dataset.status;
  const cardId = selectedCard.dataset.id;
  let newCol = currentCol;

  if (e.key === "ArrowLeft") {
    e.preventDefault();
    if (currentCol === "doing") newCol = "todo";
    else if (currentCol === "done") newCol = "doing";
  }
  else if (e.key === "ArrowRight") {
    e.preventDefault();
    if (currentCol === "todo") newCol = "doing";
    else if (currentCol === "doing") newCol = "done";
  }
  else if (e.key === "ArrowUp" || e.key === "ArrowDown") {
    e.preventDefault();
    const cardsList = selectedCard.parentElement;
    const cards = Array.from(cardsList.children);
    const index = cards.indexOf(selectedCard);

    if (e.key === "ArrowUp" && index > 0) {
      cardsList.insertBefore(selectedCard, cards[index - 1]);
    }
    else if (e.key === "ArrowDown" && index < cards.length - 1) {
      cardsList.insertBefore(selectedCard, cards[index + 1].nextSibling);
    }
    return; // geen backend-update nodig bij omhoog/omlaag binnen kolom
  }
  else {
    return; // andere toets → niks doen
  }

  // Kolom is veranderd → verplaats + update backend
  if (newCol !== currentCol) {
    showLoading("Verplaatsen…");
    selectedCard.dataset.status = newCol;
    document.querySelector(`#${newCol} .cards`).appendChild(selectedCard);

    const params = new URLSearchParams();
    params.append("action", "update");
    params.append("id", cardId);
    params.append("status", newCol);

    const script = document.createElement('script');
    script.src = `${SCRIPT_URL}?${params}&callback=handleStatusUpdate`;
    document.head.appendChild(script);
    script.onload = () => {
      document.head.removeChild(script);
      hideLoading();
    };
  }
});
  
  loadTasks();
//  setInterval(loadTasks, 30000); // Refresh elke 30 sec
</script>
</body>
</html>
